<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>OAuth2 Authorization | YaMailBot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocas-ui/2.3.3/tocas.css" />
  </head>
  <body>
    <div class="ts very narrow container">
      <br/>
      <h1 class="ts center aligned icon header">
        <i class="sign in icon"></i> Redirecting...
        <div class="sub header">
          If nothing happens - check to see if JavaScript is turned on in your browser and try to connect the bot again.
        </div>
      </h1>
    </div>

    <script>
      const access_denied = 'access_denied'; // пользователь отказал приложению в доступе
      const unauthorized_client = 'unauthorized_client'; // приложение было отклонено при модерации или только ожидает ее. Также возвращается, если приложение заблокировано

      var hash = window.location.hash;
      var subheader = document.querySelectorAll('h1.ts.header > div.sub.header');
      var access_token = ''; // OAuth-токен с запрошенными правами или с правами, указанными при регистрации приложения.
      var expires_in = 0; // Время жизни токена в секундах. 
      var token_type = ''; // Тип выданного токена. Всегда принимает значение 'bearer'.
      var state = ''; // Значение параметра state из исходного запроса, если этот параметр был передан.
      var error = ''; // Код ошибки. 
      var error_description = ''; // Описание ошибки

      document.onload = function() {
        switch (true) {
        case (hash.match(/(?:access_token)/) !== null):
          access_token = hash.match(/(?:access_token)\=([\S\s]*?)\&/)[1];
        case (hash.match(/(?:expires_in)/) !== null):
          expires_in = hash.match(/(?:expires_in)\=([\d]*?)\&/)[1];
        case (hash.match(/(?:token_type)/) !== null):
          token_type = hash.match(/(?:token_type)\=([\S\s]*?)\&/)[1];
        case (hash.match(/(?:state)/) !== null):
          state = hash.match(/(?:state)\=([\s\S]*?)\&/)[1];
        case (hash.match(/(?:error)/) !== null):
          error = hash.match(/(?:error)\=([\s\S]*?)\&/)[1];
        case (hash.match(/(?:error_description)/) !== null):
          error_description = hash.match(/(?:error_description)\=([\S\s]*?)\&/)[1];
        }

        if (access_token === null && error === null) {
          subheader.textContent = 'Unknown error. Try to give access to application again.';
          window.location.replace("https://t.me/YaMailBot");
          return
        }

        if (error !== null) {
          if (error === access_denied) {
            subheader.textContent = 'You refused the application for access.';
          } else if (error === unauthorized_client) {
            subheader.textContent = 'The application is waiting for moderation, could be rejected or blocked.';
          } else {
            subheader.textContent = 'Unknown error. Try to give access to application again.';
          }
          return
        }

        if (access_token !== null) {
          subheader.innerHTML = 'If automatic redirection does not happen - <a href="//t.me/YaMailBot?start=' + access_token + '" target="_self">click here</a>.';
          window.location.replace("https://t.me/YaMailBot?start=" + accessToken);
          return
        }
      };
      
      console.log("access_token: " + access_token);
      console.log("error: " + error);
      console.log("error_description: " + error_description);
      console.log("state: " + state);
      console.log("expires_in: " + expires_in);
      console.log("token_type: " + token_type);
    </script>
  </body>
</html>